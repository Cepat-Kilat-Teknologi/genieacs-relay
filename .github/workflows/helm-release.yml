name: Helm Chart Release

on:
  push:
    branches: [ "main" ]
    paths:
      - 'examples/helm/**'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  release:
    name: Release Helm Chart
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Get version from release tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION="0.1.0"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Update Chart.yaml version
        run: |
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.version }}/" examples/helm/genieacs-relay/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.version }}\"/" examples/helm/genieacs-relay/Chart.yaml

      - name: Package Helm Chart
        run: |
          mkdir -p .helm-release
          helm package examples/helm/genieacs-relay -d .helm-release

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Create gh-pages branch if not exists
        run: |
          if [ ! -d "gh-pages" ]; then
            mkdir gh-pages
            cd gh-pages
            git init
            git checkout -b gh-pages
          fi

      - name: Copy packaged chart
        run: |
          cp .helm-release/*.tgz gh-pages/

      - name: Generate Helm Repository Index
        run: |
          cd gh-pages
          helm repo index . --url https://cepat-kilat-teknologi.github.io/genieacs-relay

      - name: Create index.html for GitHub Pages
        run: |
          cat > gh-pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>GenieACS Relay - Helm Chart Repository</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                      line-height: 1.6;
                      color: #333;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 40px 20px;
                  }
                  .container {
                      max-width: 800px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 16px;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                      padding: 40px;
                  }
                  h1 {
                      color: #667eea;
                      margin-bottom: 10px;
                      font-size: 2.5rem;
                  }
                  .subtitle {
                      color: #666;
                      margin-bottom: 30px;
                      font-size: 1.1rem;
                  }
                  .section {
                      margin: 30px 0;
                      padding: 20px;
                      background: #f8f9fa;
                      border-radius: 8px;
                      border-left: 4px solid #667eea;
                  }
                  .section h2 {
                      color: #333;
                      margin-bottom: 15px;
                      font-size: 1.3rem;
                  }
                  pre {
                      background: #2d3748;
                      color: #e2e8f0;
                      padding: 15px;
                      border-radius: 8px;
                      overflow-x: auto;
                      font-size: 0.9rem;
                  }
                  code {
                      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                  }
                  .badge {
                      display: inline-block;
                      padding: 5px 12px;
                      background: #667eea;
                      color: white;
                      border-radius: 20px;
                      font-size: 0.85rem;
                      margin-right: 8px;
                      margin-bottom: 8px;
                  }
                  .links {
                      margin-top: 30px;
                      padding-top: 20px;
                      border-top: 1px solid #eee;
                  }
                  .links a {
                      color: #667eea;
                      text-decoration: none;
                      margin-right: 20px;
                      font-weight: 500;
                  }
                  .links a:hover {
                      text-decoration: underline;
                  }
                  .features {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                      gap: 15px;
                      margin-top: 15px;
                  }
                  .feature {
                      padding: 15px;
                      background: white;
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  .feature h3 {
                      color: #667eea;
                      font-size: 1rem;
                      margin-bottom: 5px;
                  }
                  .feature p {
                      color: #666;
                      font-size: 0.9rem;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>GenieACS Relay</h1>
                  <p class="subtitle">A lightweight relay service for managing TR-069 devices via GenieACS</p>

                  <div>
                      <span class="badge">Helm Chart</span>
                      <span class="badge">Kubernetes</span>
                      <span class="badge">TR-069</span>
                      <span class="badge">GenieACS</span>
                  </div>

                  <div class="section">
                      <h2>Quick Start</h2>
                      <p>Add the Helm repository:</p>
                      <pre><code>helm repo add genieacs-relay https://cepat-kilat-teknologi.github.io/genieacs-relay
          helm repo update</code></pre>
                  </div>

                  <div class="section">
                      <h2>Install the Chart</h2>
                      <pre><code># Install with default values
          helm install my-relay genieacs-relay/genieacs-relay

          # Install with custom values
          helm install my-relay genieacs-relay/genieacs-relay \
            --set genieacs.url="http://genieacs-nbi:7557" \
            --set genieacs.username="admin" \
            --set genieacs.password="your-password"

          # Install with values file
          helm install my-relay genieacs-relay/genieacs-relay -f values.yaml</code></pre>
                  </div>

                  <div class="section">
                      <h2>Features</h2>
                      <div class="features">
                          <div class="feature">
                              <h3>Device Management</h3>
                              <p>Manage TR-069 devices with ease</p>
                          </div>
                          <div class="feature">
                              <h3>WiFi Configuration</h3>
                              <p>Configure SSID, password, and channels</p>
                          </div>
                          <div class="feature">
                              <h3>Auto-scaling</h3>
                              <p>Built-in HPA support for scaling</p>
                          </div>
                          <div class="feature">
                              <h3>High Availability</h3>
                              <p>PodDisruptionBudget for reliability</p>
                          </div>
                      </div>
                  </div>

                  <div class="section">
                      <h2>Configuration</h2>
                      <pre><code># Example values.yaml
          replicaCount: 2

          genieacs:
            url: "http://genieacs-nbi:7557"
            username: "admin"
            password: "secret"

          service:
            type: ClusterIP
            port: 8080

          ingress:
            enabled: true
            hosts:
              - host: relay.example.com
                paths:
                  - path: /
                    pathType: Prefix</code></pre>
                  </div>

                  <div class="links">
                      <a href="https://github.com/Cepat-Kilat-Teknologi/genieacs-relay">GitHub Repository</a>
                      <a href="https://github.com/Cepat-Kilat-Teknologi/genieacs-relay/tree/main/examples/helm">Chart Source</a>
                      <a href="https://github.com/Cepat-Kilat-Teknologi/genieacs-relay/blob/main/API_REFERENCE.md">API Reference</a>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        run: |
          cd gh-pages
          git add .
          git commit -m "Release Helm chart ${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push origin gh-pages --force || {
            git push --set-upstream origin gh-pages --force
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}